<!doctype html>
<html data-bs-theme="light" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width,initial-scale=1" name="viewport" />
    <title>WireDeck</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
      .status-online {
        animation: pulse-green 2s infinite;
      }
      .status-offline {
        animation: pulse-red 2s infinite;
      }
      @keyframes pulse-green {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
        100% {
          opacity: 1;
        }
      }
      @keyframes pulse-red {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
        100% {
          opacity: 1;
        }
      }
      .table tbody tr:hover {
        background-color: var(--bs-light);
      }
      .table td,
      .table th {
        text-align: center;
        vertical-align: middle;
      }
      .table .fw-bold {
        text-align: center;
      }
      .action-buttons {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
        justify-content: center;
      }
      .docker-status {
        font-size: 0.875rem;
        border: none;
        padding: 0.25rem 0.75rem;
        cursor: default;
        margin-right: 1rem;
        border-radius: 20px;
      }
      .docker-status:hover {
        background: 0 0 !important;
      }
      .docker-status.connected {
        background-color: #198754 !important;
        color: #fff !important;
      }
      .docker-status.disconnected {
        background-color: #dc3545 !important;
        color: #fff !important;
      }
      .name-preview {
        font-family: 'Courier New', monospace;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 0.9em;
        border: 1px solid var(--bs-border-color);
      }
      [data-bs-theme='light'] .name-preview {
        background-color: #f8f9fa;
        color: #495057;
      }
      [data-bs-theme='dark'] .name-preview {
        background-color: #495057;
        color: #f8f9fa;
      }
      .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .main-app {
        display: none;
      }
      .theme-switcher {
        position: absolute;
        top: 1rem;
        right: 1rem;
      }
      .user-dropdown {
        position: relative;
      }
      .user-info {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 0.375rem 0.75rem;
        border: 1px solid #6c757d;
        border-radius: 0.375rem;
        background: 0 0;
        color: #f8f9fa;
        text-decoration: none;
      }
      .user-info:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #f8f9fa;
      }
      .action-buttons {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
      }
      .action-buttons .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
      .toast-container {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 1055;
      }
      .toast {
        min-width: 300px;
      }
      .webvnc-controls {
        margin-top: 0.5rem;
        padding: 0.75rem;
        background-color: var(--bs-light);
        border-radius: 0.375rem;
        border: 1px solid var(--bs-border-color);
      }
      [data-bs-theme='dark'] .webvnc-controls {
        background-color: var(--bs-dark);
      }
      .webvnc-badge {
        font-size: 0.75rem;
      }
      .file-upload-area {
        border: 2px dashed var(--bs-border-color);
        border-radius: 0.375rem;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .file-upload-area:hover {
        border-color: var(--bs-primary);
        background-color: var(--bs-light);
      }
      .file-upload-area.dragover {
        border-color: var(--bs-primary);
        background-color: var(--bs-primary-bg-subtle);
      }
      .config-preview {
        max-height: 200px;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        white-space: pre-wrap;
        word-break: break-all;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="theme-switcher">
      <button class="btn btn-sm btn-outline-secondary" id="loginThemeToggle" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
      </button>
    </div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
      <div class="card" style="width: 400px">
        <div class="text-white card-header bg-primary text-center">
          <h4 class="mb-0"><i class="fas me-2 fa-shield-alt"></i>WireDeck</h4>
        </div>
        <div class="card-body">
          <form autocomplete="off" id="loginForm">
            <div class="mb-3">
              <label class="form-label" for="username">Username</label>
              <input class="form-control" id="username" required />
            </div>
            <div class="mb-3">
              <label class="form-label" for="password">Password</label>
              <input class="form-control" id="password" required type="password" />
            </div>
            <button class="btn btn-primary w-100" type="submit"><i class="fas me-1 fa-sign-in-alt"></i>Login</button>
          </form>
          <div class="mt-3" id="loginAlert" style="display: none"></div>
        </div>
      </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
      <nav class="bg-dark navbar navbar-dark navbar-expand-lg">
        <div class="container-fluid">
          <span class="navbar-brand"> <i class="fas me-2 fa-shield-alt"></i> WireDeck </span>
          <div class="align-items-center d-flex">
            <div class="docker-status" id="dockerStatus"><i class="fas me-1 fa-spin fa-spinner"></i>Checking...</div>
            <button class="btn btn-sm btn-outline-light me-3" id="themeToggle" onclick="toggleTheme()">
              <i class="fas fa-moon"></i>
            </button>
            <div class="user-dropdown">
              <a class="user-info" href="#" aria-expanded="false" data-bs-toggle="dropdown">
                <i class="fas me-2 fa-user"></i>
                <span id="currentUsername">User</span>
                <i class="fas fa-chevron-down ms-2"></i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#" onclick="showChangePasswordModal()"> <i class="fas me-2 fa-key"></i>Change Password</a>
                </li>

                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item text-danger" href="#" onclick="logout()"> <i class="fas me-2 fa-sign-out-alt"></i>Logout</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </nav>

      <div class="container-fluid py-4">
        <div class="row justify-content-center">
          <div class="col-12 col-xl-10">
            <div class="text-center mb-4">
              <h1 class="display-6 fw-bold">WireGuard Multi-Instance Manager</h1>
              <p class="text-muted">Manage your WireGuard VPN instances and WebVNC services</p>
            </div>

            <div id="dockerAlert" style="display: none"></div>

            <!-- Create New Instance -->
            <div class="card mb-4">
              <div class="text-white card-header bg-primary">
                <h5 class="mb-0"><i class="fas me-2 fa-plus"></i>Create New WireGuard Instance</h5>
              </div>
              <div class="card-body">
                <form autocomplete="off" id="createForm">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label" for="instanceName">Instance Name *</label>
                      <input class="form-control" id="instanceName" required name="name" placeholder="Enter instance name (e.g., my-vpn-server)" />
                      <div class="form-text">
                        <i class="fas me-1 fa-info-circle"></i> Service name will be:
                        <span class="name-preview" id="namePreview">wg-easy-[sanitized-name]</span>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="instanceCidr">IPv4 CIDR (Optional)</label>
                      <input class="form-control" id="instanceCidr" name="ipv4Cidr" placeholder="e.g., 172.21.0.0/24" />
                      <div class="form-text"><i class="fas me-1 fa-info-circle"></i> Leave empty to use default: 172.21.0.0/24</div>
                    </div>
                  </div>
                  <div class="row g-3 mt-2">
                    <div class="col-md-6">
                      <label class="form-label" for="instanceUsername">Admin Username (Optional)</label>
                      <input class="form-control" id="instanceUsername" name="username" placeholder="Leave empty to use default" />
                      <div class="form-text"><i class="fas me-1 fa-info-circle"></i> Leave empty to use environment default</div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="instancePassword">Admin Password (Optional)</label>
                      <input class="form-control" id="instancePassword" type="password" minlength="12" name="password" placeholder="Leave empty to use default" />
                      <div class="form-text"><i class="fas me-1 fa-info-circle"></i> Leave empty to use environment default</div>
                    </div>
                  </div>
                  <div class="row g-3 mt-2">
                    <div class="col-12">
                      <button class="btn btn-primary" type="submit" id="createBtn"><i class="fas me-1 fa-plus"></i>Create Instance</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- Active Instances -->
            <div class="card">
              <div class="text-white card-header align-items-center bg-secondary d-flex justify-content-between">
                <h5 class="mb-0"><i class="fas me-2 fa-list"></i>Active Instances</h5>
                <button class="btn btn-sm btn-light" onclick="loadInstances()"><i class="fas me-1 fa-refresh"></i>Refresh</button>
              </div>
              <div class="card-body">
                <div id="instancesContainer">
                  <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading instances...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Change Password Modal -->
    <div class="fade modal" id="changePasswordModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title"><i class="fas me-2 fa-key"></i>Change Password</h5>
            <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form autocomplete="off" id="changePasswordForm">
              <div class="mb-3">
                <label class="form-label" for="currentPassword">Current Password</label>
                <input class="form-control" id="currentPassword" required type="password" />
              </div>
              <div class="mb-3">
                <label class="form-label" for="newPassword">New Password</label>
                <input class="form-control" id="newPassword" required type="password" minlength="12" />
                <div class="form-text">Password must be at least 12 characters long</div>
              </div>
              <div class="mb-3">
                <label class="form-label" for="confirmNewPassword">Confirm New Password</label>
                <input class="form-control" id="confirmNewPassword" required type="password" />
              </div>
            </form>
            <div class="mt-3" id="passwordChangeAlert" style="display: none"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-warning" type="button" id="confirmPasswordChangeBtn"><i class="fas me-1 fa-key"></i>Change Password</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Instance Modal -->
    <div class="fade modal" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="text-white bg-danger modal-header">
            <h5 class="modal-title"><i class="fas me-2 fa-trash"></i>Confirm Deletion</h5>
            <button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete the instance <strong id="deleteInstanceName"></strong>?</p>
            <p class="mb-0 small text-danger">
              <i class="fas me-1 fa-exclamation-triangle"></i> This action cannot be undone. All VPN configurations and WebVNC data will be lost.
            </p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-danger" type="button" id="confirmDeleteBtn"><i class="fas me-1 fa-trash"></i>Delete Instance</button>
          </div>
        </div>
      </div>
    </div>

    <!-- WebVNC Modal -->
    <div class="fade modal modal-lg" id="webvncModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="text-white bg-info modal-header">
            <h5 class="modal-title"><i class="fas me-2 fa-desktop"></i>WebVNC Manager - <span id="webvncInstanceName"></span></h5>
            <button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="webvncContent">
              <!-- Content will be loaded dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create WebVNC Modal -->
    <div class="fade modal modal-lg" id="createWebvncModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="text-white bg-success modal-header">
            <h5 class="modal-title"><i class="fas me-2 fa-plus"></i>Create WebVNC - <span id="createWebvncInstanceName"></span></h5>
            <button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="createWebvncForm">
              <!-- WireGuard Config Upload -->
              <div class="mb-4">
                <label class="form-label">WireGuard Configuration File *</label>
                <div class="file-upload-area" id="configUploadArea">
                  <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                  <p class="mb-2">Click to select or drag & drop your .conf file</p>
                  <small class="text-muted">Only .conf files are accepted</small>
                  <input type="file" id="configFileInput" accept=".conf" style="display: none" />
                </div>
                <div class="mt-2" id="configPreview" style="display: none">
                  <label class="form-label">Configuration Preview:</label>
                  <div class="config-preview border rounded p-2" id="configContent"></div>
                </div>
              </div>

              <!-- Login Users -->
              <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <label class="form-label mb-0">Login Users</label>
                  <button type="button" class="btn btn-sm btn-outline-primary" onclick="addLoginUserField()"><i class="fas fa-plus me-1"></i>Add User</button>
                </div>
                <div id="loginUsersContainer">
                  <!-- User fields will be added dynamically -->
                </div>
              </div>

              <!-- VNC Devices -->
              <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <label class="form-label mb-0">VNC Target Devices</label>
                  <button type="button" class="btn btn-sm btn-outline-success" onclick="addVncDeviceField()"><i class="fas fa-plus me-1"></i>Add Device</button>
                </div>
                <div id="vncDevicesContainer">
                  <!-- Device fields will be added dynamically -->
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-success" type="button" id="confirmCreateWebvncBtn"><i class="fas me-1 fa-plus"></i>Create WebVNC</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let instances = {};
      let deleteModal;
      let changePasswordModal;
      let webvncModal;
      let createWebvncModal;
      let currentDeleteInstance = null;
      let currentWebvncInstance = null;
      let currentCreateWebvncInstance = null;
      let dockerConnected = false;
      let authToken = localStorage.getItem('authToken');
      let currentUser = localStorage.getItem('currentUser');
      let wireguardConfig = '';

      // Initialize theme on page load
      document.addEventListener('DOMContentLoaded', () => {
        setTheme(getStoredTheme());
        checkAuth();
      });

      function checkAuth() {
        if (!authToken) {
          showLogin();
          return false;
        }

        fetch('/wireguard/instances', {
          headers: {
            Authorization: `Bearer ${authToken}`,
          },
        })
          .then((response) => {
            if (response.status === 401 || response.status === 403) {
              localStorage.removeItem('authToken');
              localStorage.removeItem('currentUser');
              authToken = null;
              showLogin();
            } else {
              showMainApp();
            }
          })
          .catch(() => {
            showLogin();
          });

        return true;
      }

      function showLogin() {
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
        updateLoginThemeToggleIcon(document.documentElement.getAttribute('data-bs-theme'));
      }

      function showMainApp() {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        if (currentUser) {
          document.getElementById('currentUsername').textContent = currentUser;
        }
        initializeApp();
      }

      function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        authToken = null;
        currentUser = null;
        showLogin();
      }

      // Login form handler
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Logging in...';

        try {
          const response = await fetch('/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username, password }),
          });

          const result = await response.json();

          if (response.ok) {
            authToken = result.token;
            currentUser = result.username;
            localStorage.setItem('authToken', authToken);
            localStorage.setItem('currentUser', currentUser);
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showMainApp();
          } else {
            showLoginAlert(result.error || 'Login failed', 'danger');
          }
        } catch (error) {
          showLoginAlert('Network error. Please try again.', 'danger');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });

      function showLoginAlert(message, type = 'danger') {
        const alertContainer = document.getElementById('loginAlert');
        alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        alertContainer.style.display = 'block';
        setTimeout(() => {
          alertContainer.style.display = 'none';
        }, 5000);
      }

      // Password change functionality
      function showChangePasswordModal() {
        changePasswordModal.show();
      }

      function showPasswordChangeAlert(message, type = 'danger') {
        const alertContainer = document.getElementById('passwordChangeAlert');
        alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        alertContainer.style.display = 'block';
        setTimeout(() => {
          alertContainer.style.display = 'none';
        }, 5000);
      }

      document.getElementById('confirmPasswordChangeBtn').addEventListener('click', async () => {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;

        if (!currentPassword || !newPassword || !confirmNewPassword) {
          showPasswordChangeAlert('All fields are required', 'danger');
          return;
        }

        if (newPassword !== confirmNewPassword) {
          showPasswordChangeAlert('New passwords do not match', 'danger');
          return;
        }

        if (newPassword.length < 6) {
          showPasswordChangeAlert('New password must be at least 6 characters long', 'danger');
          return;
        }

        const confirmBtn = document.getElementById('confirmPasswordChangeBtn');
        const originalText = confirmBtn.innerHTML;

        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Changing...';

        try {
          const response = await fetch('/auth/change-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ currentPassword, newPassword }),
          });

          const result = await response.json();

          if (response.ok) {
            showPasswordChangeAlert(result.message, 'success');
            document.getElementById('changePasswordForm').reset();
            setTimeout(() => {
              changePasswordModal.hide();
            }, 2000);
          } else {
            showPasswordChangeAlert(result.error || 'Password change failed', 'danger');
          }
        } catch (error) {
          showPasswordChangeAlert('Network error. Please try again.', 'danger');
        } finally {
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = originalText;
        }
      });

      // Theme management
      function getStoredTheme() {
        return localStorage.getItem('theme') || 'light';
      }

      function setStoredTheme(theme) {
        localStorage.setItem('theme', theme);
      }

      function setTheme(theme) {
        document.documentElement.setAttribute('data-bs-theme', theme);
        updateThemeToggleIcon(theme);
        updateLoginThemeToggleIcon(theme);
      }

      function updateThemeToggleIcon(theme) {
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
          if (theme === 'dark') {
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            themeToggle.title = 'Switch to light theme';
          } else {
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            themeToggle.title = 'Switch to dark theme';
          }
        }
      }

      function updateLoginThemeToggleIcon(theme) {
        const loginThemeToggle = document.getElementById('loginThemeToggle');
        if (loginThemeToggle) {
          if (theme === 'dark') {
            loginThemeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            loginThemeToggle.title = 'Switch to light theme';
          } else {
            loginThemeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            loginThemeToggle.title = 'Switch to dark theme';
          }
        }
      }

      function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        setTheme(newTheme);
        setStoredTheme(newTheme);
      }

      // Toast functionality
      function showToast(message, type = 'success', duration = 5000) {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();

        const iconMap = {
          success: 'check-circle',
          error: 'exclamation-triangle',
          warning: 'exclamation-triangle',
          info: 'info-circle',
        };

        const bgMap = {
          success: 'success',
          error: 'danger',
          warning: 'warning',
          info: 'info',
        };

        const icon = iconMap[type] || 'info-circle';
        const bgClass = bgMap[type] || 'info';

        const toastHtml = `
                <div class="toast align-items-center text-bg-${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${icon} me-2"></i>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);

        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: duration });

        toast.show();

        toastElement.addEventListener('hidden.bs.toast', () => {
          toastElement.remove();
        });
      }

      // Initialize app after successful login
      function initializeApp() {
        deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
        webvncModal = new bootstrap.Modal(document.getElementById('webvncModal'));
        createWebvncModal = new bootstrap.Modal(document.getElementById('createWebvncModal'));

        checkDockerStatus();
        loadInstances();
        setupFormHandlers();
        setupFileUpload();

        setInterval(loadInstances, 30000);
      }

      function setupFormHandlers() {
        // Create WireGuard form handler
        document.getElementById('createForm').addEventListener('submit', async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const name = formData.get('name').trim();
          const ipv4Cidr = formData.get('ipv4Cidr').trim();
          const username = formData.get('username').trim();
          const password = formData.get('password').trim();

          if (!name) {
            showToast('Please enter an instance name', 'error');
            return;
          }

          const sanitized = sanitizeServiceName(name);
          if (!sanitized) {
            showToast('Instance name contains only invalid characters', 'error');
            return;
          }

          if (instances[name]) {
            showToast('An instance with this name already exists', 'error');
            return;
          }

          const requestBody = { name };
          if (ipv4Cidr) requestBody.ipv4Cidr = ipv4Cidr;
          if (username) requestBody.username = username;
          if (password) requestBody.password = password;

          await createInstance(requestBody);
        });

        // Name preview
        document.getElementById('instanceName').addEventListener('input', (e) => {
          const sanitized = sanitizeServiceName(e.target.value);
          document.getElementById('namePreview').textContent = sanitized ? `wg-easy-${sanitized}` : 'wg-easy-[sanitized-name]';
        });

        // Create WebVNC form handler
        document.getElementById('confirmCreateWebvncBtn').addEventListener('click', async () => {
          await createWebVNC();
        });
      }

      function setupFileUpload() {
        const uploadArea = document.getElementById('configUploadArea');
        const fileInput = document.getElementById('configFileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFileUpload(files[0]);
          }
        });

        fileInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            handleFileUpload(e.target.files[0]);
          }
        });
      }

      function handleFileUpload(file) {
        if (!file.name.endsWith('.conf')) {
          showToast('Please select a valid .conf file', 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          wireguardConfig = e.target.result;
          document.getElementById('configContent').textContent = wireguardConfig;
          document.getElementById('configPreview').style.display = 'block';
        };
        reader.readAsText(file);
      }

      function addLoginUserField() {
        const container = document.getElementById('loginUsersContainer');
        const index = container.children.length;

        const userHtml = `
                <div class="row g-2 mb-2" id="loginUser${index}">
                    <div class="col-5">
                        <input type="text" class="form-control" placeholder="Username" data-field="username" required>
                    </div>
                    <div class="col-5">
                        <input type="password" class="form-control" placeholder="Password" data-field="password" required>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger w-100" onclick="removeLoginUserField(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

        container.insertAdjacentHTML('beforeend', userHtml);
      }

      function removeLoginUserField(index) {
        const element = document.getElementById(`loginUser${index}`);
        if (element) element.remove();
      }

      function addVncDeviceField() {
        const container = document.getElementById('vncDevicesContainer');
        const index = container.children.length;

        const deviceHtml = `
                <div class="border rounded p-3 mb-3" id="vncDevice${index}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">VNC Device #${index + 1}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVncDeviceField(${index})">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">Device Name *</label>
                            <input type="text" class="form-control" placeholder="e.g., Desktop-1" data-field="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">IP Address *</label>
                            <input type="text" class="form-control" placeholder="e.g., 192.168.1.100" data-field="ip" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Port *</label>
                            <input type="number" class="form-control" placeholder="5900" data-field="port" min="1" max="65535" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Path *</label>
                            <input type="text" class="form-control" placeholder="/" data-field="path" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Password (Optional)</label>
                            <input type="password" class="form-control" placeholder="VNC Password" data-field="password">
                        </div>
                    </div>
                </div>
            `;

        container.insertAdjacentHTML('beforeend', deviceHtml);
      }

      function removeVncDeviceField(index) {
        const element = document.getElementById(`vncDevice${index}`);
        if (element) element.remove();
      }

      // Docker status check
      async function checkDockerStatus() {
        try {
          const response = await fetch('/docker/status', {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          });
          const status = await response.json();

          const dockerStatus = document.getElementById('dockerStatus');
          const dockerAlert = document.getElementById('dockerAlert');
          const createBtn = document.getElementById('createBtn');

          if (status.connected) {
            dockerConnected = true;
            dockerStatus.className = 'docker-status connected';
            dockerStatus.innerHTML = '<i class="fas fa-check me-1"></i>Docker Connected';
            dockerStatus.title = `Docker ${status.version} on ${status.os}`;
            dockerAlert.style.display = 'none';
            createBtn.disabled = false;
          } else {
            dockerConnected = false;
            dockerStatus.className = 'docker-status disconnected';
            dockerStatus.innerHTML = '<i class="fas fa-times me-1"></i>Docker Disconnected';
            dockerStatus.title = status.error;
            dockerAlert.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Docker Connection Failed</h6>
                            <p class="mb-2">Cannot connect to Docker daemon:</p>
                            <ul class="mb-2">
                                <li>Ensure Docker socket is mounted: <code>/var/run/docker.sock</code></li>
                                <li>Verify container has Docker socket access</li>
                                <li>Check if Docker daemon is running on host</li>
                            </ul>
                            <small class="text-muted">Error: ${status.error}</small>
                        </div>
                    `;
            dockerAlert.style.display = 'block';
            createBtn.disabled = true;
          }
        } catch (error) {
          dockerConnected = false;
          const dockerStatus = document.getElementById('dockerStatus');
          dockerStatus.className = 'docker-status disconnected';
          dockerStatus.innerHTML = '<i class="fas fa-times me-1"></i>Connection Error';
          dockerStatus.title = error.message;
          document.getElementById('createBtn').disabled = true;
        }
      }

      async function loadInstances() {
        if (!authToken) return;

        try {
          const response = await fetch('/wireguard/instances', {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          });

          if (response.ok) {
            instances = await response.json();
            renderInstances();
          } else if (response.status === 401 || response.status === 403) {
            logout();
          } else {
            throw new Error('Failed to load instances');
          }
        } catch (error) {
          console.error('Error loading instances:', error);
          showToast('Failed to load instances', 'error');
          renderInstances();
        }
      }

      async function getWebVNCStatus(instanceName) {
        try {
          const response = await fetch(`/webvnc/instance/${instanceName}`, {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          });

          if (response.ok) {
            return await response.json();
          } else if (response.status === 404) {
            return null;
          }
        } catch (error) {
          console.error('Error getting WebVNC status:', error);
        }
        return null;
      }

      async function renderInstances() {
        const container = document.getElementById('instancesContainer');
        const instanceNames = Object.keys(instances);

        if (instanceNames.length === 0) {
          container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No instances found</h5>
                        <p class="text-muted">Create your first WireGuard instance using the form above</p>
                    </div>
                `;
          return;
        }

        let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-tag me-1"></i>Name</th>
                                <th><i class="fas fa-network-wired me-1"></i>IPv4 Address</th>
                                <th><i class="fas fa-signal me-1"></i>Status</th>
                                <th><i class="fas fa-desktop me-1"></i>WebVNC</th>
                                <th><i class="fas fa-plug me-1"></i>VPN Port</th>
                                <th><i class="fas fa-link me-1"></i>Admin</th>
                                <th><i class="fas fa-cogs me-1"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

        for (const name of instanceNames) {
          const instance = instances[name];
          const isOnline = instance.status === 'online';
          const statusClass = isOnline ? 'status-online' : 'status-offline';
          const statusColor = isOnline ? 'success' : 'danger';
          const statusIcon = isOnline ? 'check-circle' : 'times-circle';
          const statusText = isOnline ? 'Online' : 'Offline';

          // Check WebVNC status
          const webvncStatus = await getWebVNCStatus(name);
          let webvncColumn = '';

          if (webvncStatus) {
            const vncOnline = webvncStatus.status === 'online';
            const vncStatusColor = vncOnline ? 'success' : 'warning';
            const vncStatusIcon = vncOnline ? 'check-circle' : 'pause-circle';
            const vncStatusText = vncOnline ? 'Online' : 'Offline';

            webvncColumn = `
                        <div class="d-flex flex-column align-items-center gap-1">
                            <span class="badge bg-${vncStatusColor} webvnc-badge">
                                <i class="fas fa-${vncStatusIcon} me-1"></i>${vncStatusText}
                            </span>
                            ${
                              vncOnline
                                ? `
                                <a href="https://${webvncStatus.subdomain}" target="_blank" class="btn btn-xs btn-outline-info" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;">
                                    <i class="fas fa-external-link-alt me-1"></i>Open
                                </a>
                            `
                                : ''
                            }
                            <button class="btn btn-xs btn-outline-primary" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;" onclick="showWebVNCModal('${name}')">
                                <i class="fas fa-cog me-1"></i>Manage
                            </button>
                        </div>
                    `;
          } else {
            webvncColumn = `
                        <button class="btn btn-sm btn-outline-success" onclick="showCreateWebVNCModal('${name}')">
                            <i class="fas fa-plus me-1"></i>Add WebVNC
                        </button>
                    `;
          }

          tableHtml += `
                    <tr>
                        <td class="fw-bold">${name}</td>
                        <td><code>${instance.ipv4}</code></td>
                        <td>
                            <span class="badge bg-${statusColor} ${statusClass}">
                                <i class="fas fa-${statusIcon} me-1"></i>${statusText}
                            </span>
                        </td>
                        <td>${webvncColumn}</td>
                        <td><code>${instance.udpPort}/udp</code></td>
                        <td>
                            <a href="https://${instance.subdomain}" target="_blank" class="btn btn-sm ${isOnline ? 'btn-primary' : 'btn-outline-primary'}" ${!isOnline ? 'style="pointer-events: none;"' : ''}>
                                <i class="fas fa-external-link-alt me-1"></i>Open
                            </a>
                        </td>
                        <td>
                            <div class="action-buttons">
                                ${
                                  !isOnline
                                    ? `
                                    <button class="btn btn-sm btn-success" onclick="startInstance('${name}')">
                                        <i class="fas fa-play me-1"></i>Start
                                    </button>
                                `
                                    : `
                                    <button class="btn btn-sm btn-warning" onclick="stopInstance('${name}')">
                                        <i class="fas fa-stop me-1"></i>Stop
                                    </button>
                                `
                                }
                                <button class="btn btn-sm ${isOnline ? 'btn-info' : 'btn-outline-info'}" onclick="restartInstance('${name}')" ${!isOnline ? 'disabled' : ''}>
                                    <i class="fas fa-redo me-1"></i>Restart
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete('${name}')">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
        }

        tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;

        container.innerHTML = tableHtml;
      }

      async function createInstance(requestData) {
        if (!dockerConnected) {
          showToast('Cannot create instance: Docker is not connected', 'error');
          return;
        }

        const submitBtn = document.querySelector('#createForm button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';

        try {
          const response = await fetch('/wireguard/create', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify(requestData),
          });

          const result = await response.json();

          if (response.ok) {
            showToast(`Instance "${requestData.name}" created successfully!`, 'success');
            await loadInstances();
            document.getElementById('createForm').reset();
            document.getElementById('namePreview').textContent = 'wg-easy-[sanitized-name]';
          } else {
            throw new Error(result.error || 'Creation failed');
          }
        } catch (error) {
          console.error('Error creating instance:', error);
          showToast(`Failed to create instance: ${error.message}`, 'error');
          await loadInstances();
        } finally {
          submitBtn.disabled = !dockerConnected;
          submitBtn.innerHTML = originalText;
        }
      }

      async function containerAction(action, name) {
        const submitBtn = event.target;
        const originalText = submitBtn.innerHTML;

        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span>${action.charAt(0).toUpperCase() + action.slice(1)}ing...`;

        try {
          const response = await fetch(`/wireguard/${action}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ name }),
          });

          const result = await response.json();

          if (response.ok) {
            showToast(`Instance "${name}" ${action}ed successfully!`, 'success');
            await loadInstances();
          } else {
            throw new Error(result.error || `${action.charAt(0).toUpperCase() + action.slice(1)} failed`);
          }
        } catch (error) {
          console.error(`Error ${action}ing instance:`, error);
          showToast(`Failed to ${action} instance: ${error.message}`, 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }

      async function startInstance(name) {
        await containerAction('start', name);
      }

      async function stopInstance(name) {
        await containerAction('stop', name);
      }

      async function restartInstance(name) {
        await containerAction('restart', name);
      }

      function confirmDelete(name) {
        currentDeleteInstance = name;
        document.getElementById('deleteInstanceName').textContent = name;
        deleteModal.show();
      }

      document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
        if (!currentDeleteInstance) return;

        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const originalText = confirmBtn.innerHTML;

        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Deleting...';

        try {
          const response = await fetch('/wireguard/delete', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ name: currentDeleteInstance }),
          });

          const result = await response.json();

          if (response.ok) {
            showToast(`Instance "${currentDeleteInstance}" deleted successfully!`, 'success');
            await loadInstances();
            deleteModal.hide();
          } else {
            throw new Error(result.error || 'Deletion failed');
          }
        } catch (error) {
          console.error('Error deleting instance:', error);
          showToast(`Failed to delete instance: ${error.message}`, 'error');
        } finally {
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = originalText;
          currentDeleteInstance = null;
        }
      });

      // WebVNC Management Functions
      function showCreateWebVNCModal(instanceName) {
        currentCreateWebvncInstance = instanceName;
        document.getElementById('createWebvncInstanceName').textContent = instanceName;

        // Reset form
        document.getElementById('createWebvncForm').reset();
        document.getElementById('loginUsersContainer').innerHTML = '';
        document.getElementById('vncDevicesContainer').innerHTML = '';
        document.getElementById('configPreview').style.display = 'none';
        wireguardConfig = '';

        createWebvncModal.show();
      }

      async function showWebVNCModal(instanceName) {
        currentWebvncInstance = instanceName;
        document.getElementById('webvncInstanceName').textContent = instanceName;

        const contentDiv = document.getElementById('webvncContent');
        contentDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">Loading...</p></div>';

        webvncModal.show();

        try {
          const response = await fetch(`/webvnc/instance/${instanceName}`, {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          });

          if (response.ok) {
            const webvncData = await response.json();
            renderWebVNCContent(webvncData);
          } else {
            contentDiv.innerHTML = '<div class="alert alert-danger">Failed to load WebVNC data</div>';
          }
        } catch (error) {
          contentDiv.innerHTML = '<div class="alert alert-danger">Error loading WebVNC data</div>';
        }
      }

      function renderWebVNCContent(webvncData) {
        const contentDiv = document.getElementById('webvncContent');
        const isOnline = webvncData.status === 'online';

        let html = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>WebVNC Status</h6>
                        <span class="badge bg-${isOnline ? 'success' : 'warning'}">
                            <i class="fas fa-${isOnline ? 'check-circle' : 'pause-circle'} me-1"></i>
                            ${isOnline ? 'Online' : 'Offline'}
                        </span>
                    </div>
                    ${
                      isOnline
                        ? `
                        <div class="mt-2">
                            <a href="https://${webvncData.subdomain}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-external-link-alt me-1"></i>Open WebVNC
                            </a>
                        </div>
                    `
                        : ''
                    }
                </div>

                <div class="mb-3">
                    <h6>Instance Controls</h6>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm ${isOnline ? 'btn-warning' : 'btn-success'}" onclick="${isOnline ? 'stopWebVNC' : 'startWebVNC'}('${currentWebvncInstance}')">
                            <i class="fas fa-${isOnline ? 'stop' : 'play'} me-1"></i>${isOnline ? 'Stop' : 'Start'}
                        </button>
                        <button class="btn btn-sm btn-info" onclick="restartWebVNC('${currentWebvncInstance}')" ${!isOnline ? 'disabled' : ''}>
                            <i class="fas fa-redo me-1"></i>Restart
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWebVNC('${currentWebvncInstance}')">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <h6>Login Users (${webvncData.loginUsers ? webvncData.loginUsers.length : 0})</h6>
                    <div class="mb-2">
            `;

        if (webvncData.loginUsers && webvncData.loginUsers.length > 0) {
          webvncData.loginUsers.forEach((user) => {
            html += `
                        <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-1">
                            <span><i class="fas fa-user me-2"></i>${user.username}</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeWebVNCUser('${currentWebvncInstance}', '${user.username}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
          });
        } else {
          html += '<p class="text-muted small">No login users configured</p>';
        }

        html += `
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="showAddUserForm()">
                        <i class="fas fa-plus me-1"></i>Add User
                    </button>
                </div>

                <div class="mb-3">
                    <h6>VNC Devices (${webvncData.vncDevices ? webvncData.vncDevices.length : 0})</h6>
                    <div class="mb-2">
            `;

        if (webvncData.vncDevices && webvncData.vncDevices.length > 0) {
          webvncData.vncDevices.forEach((device) => {
            html += `
                        <div class="border rounded p-2 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><strong>${device.name}</strong></span>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeWebVNCDevice('${currentWebvncInstance}', '${device.name}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-network-wired me-1"></i>${device.ip}:${device.port}${device.path}
                            </small>
                        </div>
                    `;
          });
        } else {
          html += '<p class="text-muted small">No VNC devices configured</p>';
        }

        html += `
                    </div>
                    <button class="btn btn-sm btn-outline-success" onclick="showAddDeviceForm()">
                        <i class="fas fa-plus me-1"></i>Add Device
                    </button>
                </div>

                <div id="addUserForm" style="display: none;" class="mb-3">
                    <h6>Add Login User</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="text" class="form-control" id="newUsername" placeholder="Username">
                        </div>
                        <div class="col-6">
                            <input type="password" class="form-control" id="newUserPassword" placeholder="Password">
                        </div>
                        <div class="col-12">
                            <button class="btn btn-sm btn-primary me-2" onclick="addWebVNCUser()">
                                <i class="fas fa-plus me-1"></i>Add
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="hideAddUserForm()">Cancel</button>
                        </div>
                    </div>
                </div>

                <div id="addDeviceForm" style="display: none;" class="mb-3">
                    <h6>Add VNC Device</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="text" class="form-control" id="newDeviceName" placeholder="Device Name">
                        </div>
                        <div class="col-6">
                            <input type="text" class="form-control" id="newDeviceIp" placeholder="IP Address">
                        </div>
                        <div class="col-4">
                            <input type="number" class="form-control" id="newDevicePort" placeholder="Port" value="5900">
                        </div>
                        <div class="col-4">
                            <input type="text" class="form-control" id="newDevicePath" placeholder="Path" value="/">
                        </div>
                        <div class="col-4">
                            <input type="password" class="form-control" id="newDevicePassword" placeholder="Password (Optional)">
                        </div>
                        <div class="col-12">
                            <button class="btn btn-sm btn-success me-2" onclick="addWebVNCDevice()">
                                <i class="fas fa-plus me-1"></i>Add
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="hideAddDeviceForm()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;

        contentDiv.innerHTML = html;
      }

      async function createWebVNC() {
        if (!wireguardConfig) {
          showToast('Please upload a WireGuard configuration file', 'error');
          return;
        }

        // Collect login users
        const loginUsers = [];
        const userContainers = document.querySelectorAll('#loginUsersContainer > div');
        userContainers.forEach((container) => {
          const username = container.querySelector('[data-field="username"]').value;
          const password = container.querySelector('[data-field="password"]').value;
          if (username && password) {
            loginUsers.push({ username, password });
          }
        });

        // Collect VNC devices
        const vncDevices = [];
        const deviceContainers = document.querySelectorAll('#vncDevicesContainer > div');
        deviceContainers.forEach((container) => {
          const name = container.querySelector('[data-field="name"]').value;
          const ip = container.querySelector('[data-field="ip"]').value;
          const port = container.querySelector('[data-field="port"]').value;
          const path = container.querySelector('[data-field="path"]').value;
          const password = container.querySelector('[data-field="password"]').value;

          if (name && ip && port && path) {
            vncDevices.push({ name, ip, port: parseInt(port), path, password });
          }
        });

        const confirmBtn = document.getElementById('confirmCreateWebvncBtn');
        const originalText = confirmBtn.innerHTML;

        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';

        try {
          const response = await fetch('/webvnc/create', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({
              name: currentCreateWebvncInstance,
              wireguardConfig,
              loginUsers,
              vncDevices,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            showToast(`WebVNC instance created successfully!`, 'success');
            createWebvncModal.hide();
            await loadInstances();
          } else {
            throw new Error(result.error || 'Creation failed');
          }
        } catch (error) {
          console.error('Error creating WebVNC:', error);
          showToast(`Failed to create WebVNC: ${error.message}`, 'error');
        } finally {
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = originalText;
        }
      }

      // WebVNC Control Functions
      async function startWebVNC(name) {
        await webvncAction('start', name);
      }

      async function stopWebVNC(name) {
        await webvncAction('stop', name);
      }

      async function restartWebVNC(name) {
        await webvncAction('restart', name);
      }

      async function deleteWebVNC(name) {
        if (confirm(`Are you sure you want to delete the WebVNC instance for "${name}"?`)) {
          await webvncAction('delete', name);
          webvncModal.hide();
          await loadInstances();
        }
      }

      async function webvncAction(action, name) {
        try {
          const response = await fetch(`/webvnc/${action}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ name }),
          });

          const result = await response.json();

          if (response.ok) {
            showToast(`WebVNC ${action}ed successfully!`, 'success');
            if (currentWebvncInstance === name) {
              showWebVNCModal(name); // Refresh modal content
            }
          } else {
            throw new Error(result.error || `${action} failed`);
          }
        } catch (error) {
          console.error(`Error ${action}ing WebVNC:`, error);
          showToast(`Failed to ${action} WebVNC: ${error.message}`, 'error');
        }
      }

      // WebVNC User Management
      function showAddUserForm() {
        document.getElementById('addUserForm').style.display = 'block';
      }

      function hideAddUserForm() {
        document.getElementById('addUserForm').style.display = 'none';
        document.getElementById('newUsername').value = '';
        document.getElementById('newUserPassword').value = '';
      }

      async function addWebVNCUser() {
        const username = document.getElementById('newUsername').value;
        const password = document.getElementById('newUserPassword').value;

        if (!username || !password) {
          showToast('Please enter both username and password', 'error');
          return;
        }

        try {
          const response = await fetch('/webvnc/users/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({
              name: currentWebvncInstance,
              username,
              password,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            showToast('User added successfully!', 'success');
            hideAddUserForm();
            showWebVNCModal(currentWebvncInstance);
          } else {
            throw new Error(result.error || 'Failed to add user');
          }
        } catch (error) {
          console.error('Error adding user:', error);
          showToast(`Failed to add user: ${error.message}`, 'error');
        }
      }

      async function removeWebVNCUser(instanceName, username) {
        if (confirm(`Remove user "${username}"?`)) {
          try {
            const response = await fetch('/webvnc/users/remove', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${authToken}`,
              },
              body: JSON.stringify({
                name: instanceName,
                username,
              }),
            });

            const result = await response.json();

            if (response.ok) {
              showToast('User removed successfully!', 'success');
              showWebVNCModal(instanceName);
            } else {
              throw new Error(result.error || 'Failed to remove user');
            }
          } catch (error) {
            console.error('Error removing user:', error);
            showToast(`Failed to remove user: ${error.message}`, 'error');
          }
        }
      }

      // WebVNC Device Management
      function showAddDeviceForm() {
        document.getElementById('addDeviceForm').style.display = 'block';
      }

      function hideAddDeviceForm() {
        document.getElementById('addDeviceForm').style.display = 'none';
        document.getElementById('newDeviceName').value = '';
        document.getElementById('newDeviceIp').value = '';
        document.getElementById('newDevicePort').value = '5900';
        document.getElementById('newDevicePath').value = '/';
        document.getElementById('newDevicePassword').value = '';
      }

      async function addWebVNCDevice() {
        const name = document.getElementById('newDeviceName').value;
        const ip = document.getElementById('newDeviceIp').value;
        const port = document.getElementById('newDevicePort').value;
        const path = document.getElementById('newDevicePath').value;
        const password = document.getElementById('newDevicePassword').value;

        if (!name || !ip || !port || !path) {
          showToast('Please fill in all required fields', 'error');
          return;
        }

        try {
          const response = await fetch('/webvnc/devices/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({
              name: currentWebvncInstance,
              device: {
                name,
                ip,
                port: parseInt(port),
                path,
                password,
              },
            }),
          });

          const result = await response.json();

          if (response.ok) {
            showToast('Device added successfully!', 'success');
            hideAddDeviceForm();
            showWebVNCModal(currentWebvncInstance);
          } else {
            throw new Error(result.error || 'Failed to add device');
          }
        } catch (error) {
          console.error('Error adding device:', error);
          showToast(`Failed to add device: ${error.message}`, 'error');
        }
      }

      async function removeWebVNCDevice(instanceName, deviceName) {
        if (confirm(`Remove device "${deviceName}"?`)) {
          try {
            const response = await fetch('/webvnc/devices/remove', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${authToken}`,
              },
              body: JSON.stringify({
                name: instanceName,
                deviceName,
              }),
            });

            const result = await response.json();

            if (response.ok) {
              showToast('Device removed successfully!', 'success');
              showWebVNCModal(instanceName);
            } else {
              throw new Error(result.error || 'Failed to remove device');
            }
          } catch (error) {
            console.error('Error removing device:', error);
            showToast(`Failed to remove device: ${error.message}`, 'error');
          }
        }
      }

      function sanitizeServiceName(name) {
        return name
          .toLowerCase()
          .replace(/[^a-z0-9-_]/g, '-')
          .replace(/^-+|-+$/g, '')
          .replace(/-+/g, '-');
      }
    </script>
  </body>
</html>
